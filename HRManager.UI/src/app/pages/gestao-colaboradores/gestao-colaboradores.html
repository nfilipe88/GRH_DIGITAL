<div class="container mx-auto p-8">

  <div class="bg-white p-6 rounded-lg shadow-md">

    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">Colaboradores Registados</h2>

      <button (click)="abrirModalNovo()"
        class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
        Adicionar Colaborador
      </button>
    </div>

    <div *ngIf="feedbackMessage" class="mb-4 p-3 rounded"
      [ngClass]="{'bg-red-100 text-red-700': isError, 'bg-green-100 text-green-700': !isError}">
      {{ feedbackMessage }}
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
            <!-- Mostrar Instituição apenas para GestorMaster -->
            @if (isMaster()) {
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Instituição</th>
            }
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cargo</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ações</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let col of listaColaboradores">
            <td class="px-6 py-4 whitespace-nowrap">{{ col.nomeCompleto }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ col.email }}</td>
            <!-- Mostrar coluna Instituição apenas para GestorMaster -->
            @if (isMaster()) {
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ col.nomeInstituicao }}</td>
            }
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ col.cargo }}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                [ngClass]="col.isAtivo ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                {{ col.isAtivo ? 'Ativo' : 'Inativo' }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button (click)="selecionarParaEditar(col)"
                class="text-indigo-600 hover:text-indigo-900 mr-4">Editar</button>
              <button (click)="mudarEstado(col)" class="text-yellow-600 hover:text-yellow-900 mr-4">
                {{ col.isAtivo ? 'Desativar' : 'Ativar' }}
              </button>
              <button (click)="selecionarParaDeletar(col)" class="text-red-600 hover:text-red-900">Eliminar</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div *ngIf="isModalAberto"
    class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50  backdrop-blur-sm">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">

      <h3 class="text-lg font-semibold mb-4">
        {{ idColaboradorEmEdicao ? 'Editar Colaborador' : 'Novo Colaborador' }}
      </h3>

      <form [formGroup]="colaboradorForm" (ngSubmit)="onSubmit()">
        <div class="space-y-4">

          <div class="grid grid-cols-1 gap-x-6 gap-y-4 sm:grid-cols-6">

            <div class="sm:col-span-4">
              <label class="block text-sm font-medium leading-6 text-gray-900">Nome Completo *</label>
              <div class="mt-2">
                <input type="text" formControlName="nomeCompleto"
                  class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6">
                <span
                  *ngIf="colaboradorForm.get('nomeCompleto')?.invalid && colaboradorForm.get('nomeCompleto')?.touched"
                  class="text-red-500 text-xs">
                  Nome obrigatório (mín. 3 letras).
                </span>
              </div>
            </div>

            <div class="sm:col-span-4">
              <label class="block text-sm font-bold text-gray-700 mb-1">
                Instituição
                @if(isMaster()) { <span class="text-blue-600 text-xs">(Master: Selecione)</span> }
              </label>

              @if (isMaster()) {
              <select formControlName="instituicaoId" class="block w-full border border-gray-300 rounded p-2 bg-white">
                <option [ngValue]="null" disabled>Selecione uma instituição...</option>
                @for (inst of instituicoes(); track inst.id) {
                <option [ngValue]="inst.id">{{ inst.nome }}</option>
                }
              </select>
              }
              @else {
              <input type="text" value="A Minha Instituição (Bloqueado)" readonly
                class="block w-full bg-gray-100 border border-gray-300 rounded p-2 text-gray-500 cursor-not-allowed">
              }
            </div>

            <div class="sm:col-span-2">
              <label class="block text-sm font-medium leading-6 text-gray-900">NIF *</label>
              <input type="text" formControlName="nif" placeholder="123456789"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
              <span *ngIf="colaboradorForm.get('nif')?.errors?.['pattern'] && colaboradorForm.get('nif')?.touched"
                class="text-red-500 text-xs">
                NIF inválido (deve ter 9 dígitos).
              </span>
            </div>

            <div class="sm:col-span-4">
              <label class="block text-sm font-medium leading-6 text-gray-900">Email Pessoal *</label>
              <input type="email" formControlName="emailPessoal"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
              <span *ngIf="colaboradorForm.get('emailPessoal')?.invalid && colaboradorForm.get('emailPessoal')?.touched"
                class="text-red-500 text-xs">
                Email inválido.
              </span>
            </div>

            <div class="sm:col-span-2">
              <label class="block text-sm font-medium leading-6 text-gray-900">Nº Agente</label>
              <input type="number" formControlName="numeroAgente"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-2">
              <label class="block text-sm font-medium leading-6 text-gray-900">Telemóvel</label>
              <input type="tel" formControlName="telemovel"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-4">
              <label class="block text-sm font-medium leading-6 text-gray-900">Morada</label>
              <input type="text" formControlName="morada"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-2">
              <label class="block text-sm font-medium leading-6 text-gray-900">Data Nascimento</label>
              <input type="date" formControlName="dataNascimento"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-2">
              <label class="block text-sm font-medium leading-6 text-gray-900">Data Admissão *</label>
              <input type="date" formControlName="dataAdmissao"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="relative">
              <label class="block text-sm font-medium text-gray-700">Cargo</label>

              <input type="text" [value]="termoPesquisaCargo()" (input)="aoDigitarCargo($event)"
                (focus)="mostrarDropdownCargos.set(true)" placeholder="Pesquisar cargo..."
                class="mt-1 block w-full border border-gray-300 rounded p-2">

              @if (mostrarDropdownCargos() && cargosFiltrados().length > 0) {
              <ul
                class="absolute z-10 w-full bg-white border border-gray-300 rounded shadow-lg max-h-48 overflow-y-auto mt-1">
                @for (cargo of cargosFiltrados(); track cargo.id) {
                <li (click)="selecionarCargo(cargo)" class="p-2 hover:bg-blue-50 cursor-pointer border-b last:border-0">
                  {{ cargo.nome }}
                </li>
                }
              </ul>
              }

              @if (colaboradorForm.get('cargoId')?.invalid && colaboradorForm.get('cargoId')?.touched) {
              <p class="text-xs text-red-500 mt-1">Selecione um cargo válido da lista.</p>
              }
            </div>

            <div class="sm:col-span-2">
              <label class="block text-sm font-medium leading-6 text-gray-900">Tipo Contrato</label>
              <select formControlName="tipoContrato"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600 sm:text-sm sm:leading-6">
                <option value="">Selecione...</option>
                <option value="Sem Termo">Sem Termo (Efetivo)</option>
                <option value="Termo Certo">Termo Certo</option>
                <option value="Termo Incerto">Termo Incerto</option>
                <option value="Estágio">Estágio</option>
                <option value="Prestação de Serviços">Prestação de Serviços</option>
              </select>
            </div>

            <div class="sm:col-span-2">
              <label class="block text-sm font-medium leading-6 text-gray-900">Salário Base</label>
              <input type="number" formControlName="salarioBase"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-3">
              <label class="block text-sm font-medium leading-6 text-gray-900">IBAN</label>
              <input type="text" formControlName="iban"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-3">
              <label class="block text-sm font-medium leading-6 text-gray-900">Departamento</label>
              <input type="text" formControlName="departamento"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-3">
              <label class="block text-sm font-medium leading-6 text-gray-900">Localização</label>
              <input type="text" formControlName="localizacao"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

          </div>
        </div>

        <div class="mt-6 flex items-center justify-end gap-x-6">
          <button type="button" (click)="fecharModal()"
            class="rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
            Cancelar
          </button>

          <button type="submit" [ngClass]="{'opacity-50 cursor-not-allowed': colaboradorForm.invalid}"
            class="rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600">
            Salvar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Modal de Transferência de Gestor -->
@if (mostrarModalTransferencia()) {
<div
  class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
  <div class="bg-white p-5 border w-96 shadow-lg rounded-md">
    <div class="mt-3 text-center">
      <h3 class="text-lg leading-6 font-medium text-red-600">Atenção: Transferência Obrigatória</h3>
      <div class="mt-2 px-7 py-3">
        <p class="text-sm text-gray-500 mb-4">
          Este colaborador gere uma equipa. Selecione o novo gestor para quem a equipa será transferida.
        </p>

        <label class="block text-left text-sm font-bold text-gray-700 mb-1">Novo Gestor</label>
        <select [(ngModel)]="novoGestorId" class="w-full p-2 border rounded mb-4">
          <option [ngValue]="null" disabled>Selecione...</option>
          @for (g of potenciaisGestores(); track g.id) {
          <option [value]="g.id">{{ g.nomeCompleto }}</option>
          }
        </select>
      </div>

      <div class="items-center px-4 py-3">
        <button (click)="confirmarTransferencia()" [disabled]="!novoGestorId" [class.opacity-50]="!novoGestorId"
          class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
          Transferir e Desativar
        </button>
        <button (click)="mostrarModalTransferencia.set(false)"
          class="mt-3 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div>
}
