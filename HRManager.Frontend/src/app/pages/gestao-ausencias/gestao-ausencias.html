<div class="container mx-auto p-8">

  <h1 class="text-3xl font-bold text-gray-800 mb-6">Gestão de Ausências</h1>

  @if (feedbackMessage) {
  <div [ngClass]="isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'"
    class="p-4 rounded mb-6 shadow-sm">
    {{ feedbackMessage }}
  </div>
  }

  <div class="bg-white p-6 rounded-lg shadow-md">
    <div class="overflow-x-auto">
      <div class="flex float-end items-center gap-2 bg-white p-2 rounded-lg shadow-sm">
        <select [(ngModel)]="filtroMes" class="p-2 border rounded text-sm">
          <option [value]="1">Janeiro</option>
          <option [value]="2">Fevereiro</option>
          <option [value]="3">Março</option>
          <option [value]="4">Abril</option>
          <option [value]="5">Maio</option>
          <option [value]="6">Junho</option>
          <option [value]="7">Julho</option>
          <option [value]="8">Agosto</option>
          <option [value]="9">Setembro</option>
          <option [value]="10">Outubro</option>
          <option [value]="11">Novembro</option>
          <option [value]="12">Dezembro</option>
        </select>

        <input type="number" [(ngModel)]="filtroAno" class="p-2 border rounded text-sm w-20" placeholder="Ano">

        <button (click)="exportarExcel()" [disabled]="isExporting"
        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm flex items-center gap-2 disabled:opacity-50">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
        </svg>
        {{ isExporting ? 'A gerar...' : 'Exportar Excel' }}
      </button>
    </div>
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Colaborador</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Período</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dias</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Anexo</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Ações</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          @for (item of listaAusencias; track item.id) {
          <tr [ngClass]="{'bg-yellow-50': item.estado === 'Pendente'}">
            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">
              {{ item.nomeColaborador }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              {{ item.tipo }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              {{ item.dataInicio | date:'dd/MM' }} a {{ item.dataFim | date:'dd/MM/yyyy' }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              {{ item.diasTotal }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span [ngClass]="{
                  'bg-yellow-100 text-yellow-800': item.estado === 'Pendente',
                  'bg-green-100 text-green-800': item.estado === 'Aprovada',
                  'bg-red-100 text-red-800': item.estado === 'Rejeitada'
                }" class="px-2 py-1 rounded-full text-xs font-semibold">
                {{ item.estado }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
              @if (item.caminhoDocumento) {
              <a [href]="getDocumentoUrl(item.caminhoDocumento)" target="_blank"
                class="text-blue-600 hover:text-blue-900 font-medium underline flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                  stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13" />
                </svg>
                Ver
              </a>
              } @else {
              <span class="text-gray-400">-</span>
              }
            </td>

            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              @if (item.estado === 'Pendente') {
              <div class="flex justify-end gap-2">
                <button (click)="aprovar(item)" class="text-green-600 hover:text-green-900 font-bold" title="Aprovar">
                  ✓
                </button>
                <button (click)="abrirModalRejeicao(item)" class="text-red-600 hover:text-red-900 font-bold"
                  title="Rejeitar">
                  ✕
                </button>
              </div>
              } @else {
              <span class="text-gray-400 text-xs">-</span>
              }
            </td>
          </tr>
          } @empty {
          <tr>
            <td colspan="6" class="text-center py-8 text-gray-500">
              Não há solicitações de ausência registadas.
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  @if (isModalRejeicaoAberto) {
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" (click)="fecharModal()"></div>

    <div class="bg-white p-6 rounded-lg shadow-xl z-10 w-full max-w-md">
      <h2 class="text-lg font-bold mb-2 text-red-600">Rejeitar Solicitação</h2>
      <p class="text-sm text-gray-600 mb-4">Por favor, indique o motivo da rejeição para notificar o colaborador.</p>

      <textarea [(ngModel)]="motivoRejeicao" rows="3"
        class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500"
        placeholder="Ex: Período solicitado coincide com pico de trabalho..."></textarea>

      <div class="flex justify-end gap-3 mt-4">
        <button (click)="fecharModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded hover:bg-gray-200">
          Cancelar
        </button>
        <button (click)="confirmarRejeicao()" class="px-4 py-2 text-white bg-red-600 rounded hover:bg-red-700">
          Confirmar Rejeição
        </button>
      </div>
    </div>
  </div>
  }

</div>
