<div class="container mx-auto p-8">

  <div class="bg-white p-6 rounded-lg shadow-md">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">Colaboradores Registados</h2>

      <button (click)="abrirModalNovo()"
        class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
        Adicionar Colaborador
      </button>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">NIF</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Instituição</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cargo</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          @for (colab of listaColaboradores; track colab.id) {
          <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ colab.nomeCompleto }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ colab.emailPessoal }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ colab.nif }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ colab.nomeInstituicao }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ colab.cargo || 'N/D' }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
              <button (click)="selecionarParaEditar(colab)" class="text-blue-600 hover:text-blue-900">
                Editar
              </button>
              <button (click)="mudarEstado(colab)"
                [ngClass]="colab.isAtivo ? 'text-red-600 hover:text-red-900' : 'text-green-600 hover:text-green-900'">
                {{ colab.isAtivo ? 'Desativar' : 'Reativar' }}
              </button>
              <button (click)="selecionarParaDeletar(colab)" class="text-red-600 hover:text-red-900">
                Eliminar
              </button>
            </td>
          </tr>
          } @empty {
          <tr>
            <td colspan="6" class="text-center py-4 text-gray-500">
              Nenhum colaborador encontrado.
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  @if (isModalAberto) {
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div (click)="fecharModal()" class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>

    <div class="bg-white p-6 rounded-lg shadow-xl z-10 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">

      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">
          {{ idColaboradorEmEdicao ? 'Editar' : 'Cadastrar Novo' }} Colaborador
        </h2>
        <button (click)="fecharModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
      </div>

      <form (ngSubmit)="onSubmit()" #colaboradorForm="ngForm">

        @if (feedbackMessage) {
        <div [ngClass]="isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'" class="p-4 rounded mb-4">
          {{ feedbackMessage }}
        </div>
        }

        <div class="border-b border-gray-900/10 pb-12">
          <h2 class="text-base font-semibold leading-7 text-gray-900">Dados Pessoais</h2>

          <div class="mt-6 grid grid-cols-1 gap-x-6 gap-y-6 sm:grid-cols-6">

            <div class="sm:col-span-3">
              <label class="block text-sm font-medium leading-6 text-gray-900">Nome Completo *</label>
              <input type="text" name="nome" required minlength="3" [(ngModel)]="dadosFormulario.nomeCompleto"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-3">
              <label class="block text-sm font-medium leading-6 text-gray-900">Email Pessoal *</label>
              <input type="email" name="email" required [(ngModel)]="dadosFormulario.emailPessoal"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-2">
              <label class="block text-sm font-medium leading-6 text-gray-900">NIF *</label>
              <input type="text" name="nif" required title="Deve conter 9 dígitos"
                [(ngModel)]="dadosFormulario.nif"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-2">
              <label class="block text-sm font-medium leading-6 text-gray-900">Telemóvel</label>
              <input type="number" name="telemovel" [(ngModel)]="dadosFormulario.telemovel"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-2">
              <label class="block text-sm font-medium leading-6 text-gray-900">Data de Nascimento</label>
              <input type="date" name="dataNascimento" [(ngModel)]="dadosFormulario.dataNascimento"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-6">
              <label class="block text-sm font-medium leading-6 text-gray-900">Morada</label>
              <input type="text" name="morada" [(ngModel)]="dadosFormulario.morada"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

          </div>
        </div>

        <div class="border-b border-gray-900/10 pb-12 mt-8">
          <h2 class="text-base font-semibold leading-7 text-gray-900">Dados Profissionais</h2>

          @if(loggedInUserRole === 'GestorMaster') {
          <div class="sm:col-span-3">
            <label class="block text-sm font-medium leading-6 text-gray-900">Instituição *</label>
            <select name="instituicao" required [(ngModel)]="dadosFormulario.instituicaoId"
              class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
              <option [ngValue]="null" disabled>Selecione uma instituição</option>
              @for (inst of listaInstituicoes; track inst.id) {
              <option [value]="inst.id">{{ inst.nome }}</option>
              }
            </select>
          </div>
          }

          @if(loggedInUserRole === 'GestorRH') {
          <div class="sm:col-span-3">
            <label class="block text-sm font-medium leading-6 text-gray-900">Instituição *</label>

            <!-- Mostra o nome da instituição como texto -->
            <div class="mt-2 p-2 bg-gray-50 rounded-md border border-gray-300">
              <strong>{{ nomeInstituicaoGestor }}</strong>
              <span class="text-xs text-gray-500 ml-2">(Vinculada automaticamente)</span>
            </div>

            <!-- Campo hidden para enviar o ID -->
            <input name="instituicaoId" [(ngModel)]="dadosFormulario.instituicaoId">
          </div>
          }

          <div class="mt-6 grid grid-cols-1 gap-x-6 gap-y-6 sm:grid-cols-6">

            <div class="sm:col-span-3">
              <label class="block text-sm font-medium leading-6 text-gray-900">Data de Admissão *</label>
              <input type="date" name="dataAdmissao" required [(ngModel)]="dadosFormulario.dataAdmissao"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-3">
              <label class="block text-sm font-medium leading-6 text-gray-900">Cargo</label>
              <input type="text" name="cargo" [(ngModel)]="dadosFormulario.cargo"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-3">
              <label class="block text-sm font-medium leading-6 text-gray-900">Tipo Contrato</label>
              <input type="text" name="tipoContrato" [(ngModel)]="dadosFormulario.tipoContrato"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-3">
              <label class="block text-sm font-medium leading-6 text-gray-900">Salário Base</label>
              <input type="number" name="salario" min="0" [(ngModel)]="dadosFormulario.salarioBase"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-3">
              <label class="block text-sm font-medium leading-6 text-gray-900">IBAN</label>
              <input type="text" name="iban" [(ngModel)]="dadosFormulario.iban"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-3">
              <label class="block text-sm font-medium leading-6 text-gray-900">Nº Agente</label>
              <input type="number" name="agente" [(ngModel)]="dadosFormulario.numeroAgente"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-3">
              <label class="block text-sm font-medium leading-6 text-gray-900">Departamento</label>
              <input type="text" name="departamento" [(ngModel)]="dadosFormulario.departamento"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

            <div class="sm:col-span-3">
              <label class="block text-sm font-medium leading-6 text-gray-900">Localização</label>
              <input type="text" name="localizacao" [(ngModel)]="dadosFormulario.localizacao"
                class="mt-2 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600">
            </div>

          </div>
        </div>

        <div class="mt-6 flex items-center justify-end gap-x-6">
          <button type="button" (click)="fecharModal()"
            class="rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
            Cancelar
          </button>
          <button type="submit" [disabled]="!colaboradorForm.form.valid"
            class="rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 disabled:opacity-50">
            {{ idColaboradorEmEdicao ? 'Guardar Alterações' : 'Cadastrar Colaborador' }}
          </button>
        </div>
      </form>
    </div>
  </div>
  }
</div>
